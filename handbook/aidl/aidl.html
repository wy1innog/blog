<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>AIDL详解 | 我要蓝</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="start learn Android Framework">
    
    <link rel="preload" href="/blog/assets/css/0.styles.22a11561.css" as="style"><link rel="preload" href="/blog/assets/js/app.a89a3ba2.js" as="script"><link rel="preload" href="/blog/assets/js/3.b8b532c4.js" as="script"><link rel="preload" href="/blog/assets/js/1.4116e08c.js" as="script"><link rel="preload" href="/blog/assets/js/12.eb8f308d.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.256ac970.js"><link rel="prefetch" href="/blog/assets/js/11.09d62205.js"><link rel="prefetch" href="/blog/assets/js/13.c337f25e.js"><link rel="prefetch" href="/blog/assets/js/14.c4d557da.js"><link rel="prefetch" href="/blog/assets/js/15.1cc4f654.js"><link rel="prefetch" href="/blog/assets/js/16.78f4eb34.js"><link rel="prefetch" href="/blog/assets/js/17.758f5b42.js"><link rel="prefetch" href="/blog/assets/js/18.c2e5bf9f.js"><link rel="prefetch" href="/blog/assets/js/19.89036e2f.js"><link rel="prefetch" href="/blog/assets/js/4.1c7aa095.js"><link rel="prefetch" href="/blog/assets/js/5.ae39bca9.js"><link rel="prefetch" href="/blog/assets/js/6.a2711616.js"><link rel="prefetch" href="/blog/assets/js/7.eb9034a0.js"><link rel="prefetch" href="/blog/assets/js/8.ac666e15.js"><link rel="prefetch" href="/blog/assets/js/9.52ebb6c2.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.22a11561.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>我要蓝</h3> <p class="description" data-v-59e6cb88>start learn Android Framework</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>wyanlin</span>
          
        <!---->
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">我要蓝</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      我的Github
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/wy1innog" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="http://wy1in-md-picture.oss-cn-shanghai.aliyuncs.com/blog/avator/avator.jpg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    wyanlin
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>8</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>0</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      我的Github
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/wy1innog" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/blog/handbook/android/自定义系统服务" class="sidebar-heading clickable open"><span>Android系统</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/handbook/android/自定义系统服务.html" class="sidebar-link">自定义系统服务</a></li><li><a href="/blog/handbook/android/自定义按键添加.html" class="sidebar-link">自定义按键添加</a></li><li><a href="/blog/handbook/aidl/aidl.html" aria-current="page" class="active sidebar-link">AIDL详解</a></li><li><a href="/blog/handbook/android/Android开机动画详解.html" class="sidebar-link">Android开机动画详解</a></li><li><a href="/blog/handbook/android/编译技巧.html" class="sidebar-link">编译技巧</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/handbook/telephony/Android4.4网络上报流程" class="sidebar-heading clickable"><span>Telephony</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/handbook/telephony/Android4.4网络上报流程.html" class="sidebar-link">Android4.4 网络上报流程</a></li><li><a href="/blog/handbook/telephony/Android4.4短信发送接收流程.html" class="sidebar-link">Android4.4 短信发送接收流程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/handbook/problem/Wifi跨进程调用root权限" class="sidebar-heading clickable"><span>问题记录</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/handbook/problem/Wifi跨进程调用root权限.html" class="sidebar-link">Wifi跨进程调用root权限</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88></h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>wyanlin</span>
          
        <!---->
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">AIDL详解</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>wyanlin</span></i> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h1 id="aidl详解"><a href="#aidl详解" class="header-anchor">#</a> AIDL详解</h1> <p>Created by: wylin
Created time: May 27, 2023 4:57 PM
Status: Approved</p> <h1 id="一、aidl简介"><a href="#一、aidl简介" class="header-anchor">#</a> 一、AIDL简介</h1> <p><code>AIDL</code> 全称<code>Android</code> 接口定义语言（<code>Android Interface Definition Language</code>），是一种用于定义客户端和服务端之间的通信接口的语言，它可以让不同进程之间通过<code>IPC</code>（进程间通信）进行数据交互。<code>AIDL</code>的架构可以看作是一种<code>CS（Client-Server）</code>架构，即客户端-服务端架构。简单介绍如下：</p> <ol><li>客户端是指需要调用服务端提供的数据或功能的应用，它通过绑定服务端的<code>Service</code>来获取一个<code>IBinder</code>对象，然后通过该对象调用服务端暴露出来的接口方法 。</li> <li>服务端是指提供数据或功能给客户端的应用，它通过创建一个<code>Service</code>并在<code>onBind()</code>方法中返回一个<code>IBinder</code>对象来实现通信接口，该对象需要重写<code>.aidl</code>文件中定义的接口方法 。</li> <li>客户端和服务端需要共享一个<code>.aidl</code>文件，用来声明通信接口和方法，该文件会被<code>Android SDK</code>工具转换成一个<code>Java</code>接口，该接口包含一个<code>Stub</code>类和一个<code>Proxy</code>类 。</li></ol> <h1 id="二、aidl使用场景"><a href="#二、aidl使用场景" class="header-anchor">#</a> 二、AIDL使用场景</h1> <p><code>Android</code>系统中的<code>IPC</code>不只有<code>AIDL</code>，还提供了以下几种常用的<code>IPC</code>的方案：</p> <ul><li><p><strong>Messager</strong></p> <p>一种基于<code>AIDL</code>的<code>IPC</code>通信的方式，它对<code>AIDL</code>进行了封装，简化了使用过程，只需要创建一个<code>Handler</code>对象来处理消息。<code>Messenger</code>只支持单线程串行请求，只能传输<code>Message</code>对象，不能传输自定义的<code>Parcelable</code>对象。</p></li> <li><p><strong>ContentProvider</strong></p> <p>一种用于提供数据访问接口的<code>IPC</code>通信的方式，它可以让不同进程之间通过<code>URI</code>和<code>Cursor</code>进行数据交互。<code>ContentProvider</code>可以处理多线程并发请求，可以传输任意类型的数据，但使用过程比较繁琐，需要实现多个方法。</p></li> <li><p><strong>Socket</strong></p> <p>一种基于<code>TCP/IP</code>协议的<code>IPC</code>通信的方式，它可以让不同进程之间通过网络套接字进行数据交互。<code>Socket</code>可以处理多线程并发请求，可以传输任意类型的数据，但使用过程比较底层，需要处理网络异常和安全问题。</p></li></ul> <p>可以根据不同的场景和需求，选择合适的<code>IPC</code>的方式。一般来说：
如果需要实现<strong>跨应用的数据共享</strong>，可以使用<code>ContentProvider</code>。
如果需要实现<strong>跨应用的功能调用</strong>，可以使用<code>AIDL</code>。
如果需要实现<strong>跨应用的消息传递</strong>，可以使用<code>Messenger</code>。
如果需要实现<strong>跨网络的数据交换</strong>，可以使用<code>Socket</code>。</p> <h1 id="三、实践"><a href="#三、实践" class="header-anchor">#</a> 三、实践</h1> <p>假设我们有一个服务端，提供一个计算器的功能，可以进行加减乘除等多种运算。我们想让其他客户端应用也能调用这个服务端，进行计算。</p> <p>在实际工作中，可以将<code>AIDL</code>的接口封装到一个独立的工程（<code>Module</code>）中，使用时将该工程编译成一个<code>jar</code>包，再交给其它模块使用。这样做可以避免需要同时在<code>APP</code>工程以及<code>Service</code>工程中定义<code>AIDL</code>接口的情况，也方便我们后期对<code>AIDL</code>文件进行修改和维护。</p> <ol><li><p>创建<code>SDK</code>工程，定义<code>AIDL</code>接口</p> <p>在<code>SDK</code>工程中，定义一个<code>AIDL</code>接口，声明我们想要提供的方法和参数。例如，我们可以创建一个<code>ICalculator.aidl</code>文件，内容如下：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>interface ICalculator <span class="token punctuation">{</span>
		int add<span class="token punctuation">(</span>int a, int b<span class="token punctuation">)</span><span class="token punctuation">;</span>
		int subtract<span class="token punctuation">(</span>int a, int b<span class="token punctuation">)</span><span class="token punctuation">;</span>
		int multiply<span class="token punctuation">(</span>int a, int b<span class="token punctuation">)</span><span class="token punctuation">;</span>
		int divide<span class="token punctuation">(</span>int a, int b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>创建<code>Service</code>工程，实现<code>AIDL</code>接口</p> <ul><li>在服务端应用中，创建一个<code>Service</code>类，实现<code>AIDL</code>接口，并在<code>onBind</code>方法中返回一个<code>IBinder</code>对象。例如，可以创建一个<code>CalculatorService</code>类</li> <li>在服务端应用中，注册<code>Service</code>，并设置<code>android:enabled</code>和<code>android:exported</code>属性为<code>true</code>，以便其他应用可以访问它</li></ul> <p>如果需要还可以添加一个<code>intent-filter</code>，指定一个<code>action</code>，让其他应用可以通过<code>intent</code>启动服务，同时服务端也可以通过读取<code>intent</code>中的<code>action</code>来过滤绑定请求</p> <ul><li><code>Android8</code> 之后<code>Service</code>启动需要添加前台<code>Service</code></li></ul></li> <li><p>创建App工程，调用<code>AIDL</code>接口</p> <p>在客户端应用中，创建一个<code>ServiceConnection</code>对象，实现<code>onServiceConnected</code>和<code>onServiceDisconnected</code>方法，在<code>onServiceConnected</code>方法中获取<code>IBinder</code>对象的代理，并转换为<code>AIDL</code>接口类型。</p></li></ol> <h1 id="四、问题"><a href="#四、问题" class="header-anchor">#</a> 四、问题</h1> <h2 id="_1-数据类型"><a href="#_1-数据类型" class="header-anchor">#</a> 1. 数据类型</h2> <p><code>AIDL</code>支持的数据类型有：
<code>Java</code>编程语言中的所有原始类型（如<code>int</code>、<code>long</code>、<code>char</code>、<code>boolean</code>等）
<code>String</code>和<code>CharSequence</code> <code>List</code>，只支持<code>ArrayList</code>,里面每个元素都必须能够被<code>AIDL</code>支持
<code>Map</code>，只支持<code>HashMap</code>,里面的每个元素都必须被<code>AIDL</code>支持,包括<code>key</code>和<code>value</code> <code>Parcelable</code>，所有实现了<code>Parcelable</code>接口的对象
<code>Serializable</code>，所有实现了<code>Serializable</code>接口的对象
<code>AIDL</code>，所有的<code>AIDL</code>接口本身也可以在<code>AIDL</code>文件中使用</p> <ul><li><p><strong>Parcelable</strong></p> <p>在安卓中非基本数据类型的对象，除了<code>String</code>和<code>CharSequence</code>都是不可以直接通过<code>AIDL</code>进行传输的，需要先进行序列化操作。序列化就是将对象转换为可存储或可传输的状态，序列化后的对象可以在网络上进行传输，也可以存储到本地。
<code>Parcelable</code> 是安卓实现的可序列化接口。它假定一种特定的结构和处理方式，这样一个实现了 <code>Parcelable</code>接口的对象可以相对快速地进行序列化和反序列化。
为了将一个对象写入 <code>Parcel</code>，该对象必须实现 <code>Parcelable</code> 接口，并提供 <code>writeToParcel (android.os.Parcel, int)</code> 方法和一个非空的 <code>CREATOR</code> 字段，该字段实现了 <code>Parcelable.Creator</code> 接口。</p></li> <li><p><strong>Serializable</strong></p> <p><code>Serializable</code> 是 <code>Java</code> 提供的一个序列化接口，它是一个空接口，为对象提供标准的序列化和反序列化操作。使用 <code>Serializable</code> 来实现序列化相当简单，只需对象实现了<code>Serializable</code> 接口即可实现默认的序列化过程。</p> <p><code>Serializable</code> 的序列化和反序列化过程由系统自动完成。</p></li></ul> <table><thead><tr><th>类型</th> <th>优点</th> <th>缺点</th></tr></thead> <tbody><tr><td>Parcelable</td> <td>直接在内存中进行读写，效率较高，而且没有额外的开销。</td> <td>需要开发者手动编写代码，实现 writeToParcel 方法和 Parcelable.Creator 接口，实现上较为繁琐。</td></tr> <tr><td><code>Serializable</code> 实现简单，不需要开发者手动编写大量的代码</td> <td>使用了反射机制，效率较低，而且会产生大量的临时变量，增加内存开销。</td> <td></td></tr></tbody></table> <p>一般来说，如果需要将数据通过网络传输或者持久化到本地，建议使用 <code>Serializable</code> 接口，如果只是在应用内部进行数据传递，建议使用 <code>Parcelable</code>接口。</p> <h2 id="_2-数据流方向"><a href="#_2-数据流方向" class="header-anchor">#</a> 2. 数据流方向</h2> <p>在传递序列化参数时，必须定义这些参数的数据流方向，<code>in</code>、<code>out</code>、<code>inout</code>关键字的影响主要体现在参数对象在传输过程中是否被复制和修改。具体来说：</p> <ul><li><strong>in</strong>：表示数据从客户端流向服务端，客户端会将参数对象复制一份并发送给服务端，服务端收到后可以对该对象进行修改，但不会影响客户端的原始对象 。</li> <li><strong>out</strong>：表示数据从服务端流向客户端，客户端会将参数对象的空引用发送给服务端，服务端收到后可以创建一个新的对象并赋值给该引用，然后返回给客户端，客户端会将原始对象替换成服务端返回的对象 。</li> <li><strong>inout</strong>：表示数据双向流动，客户端会将参数对象复制一份并发送给服务端，服务端收到后可以对该对象进行修改，并将修改后的对象返回给客户端，客户端会将原始对象替换成服务端返回的对象 。</li></ul> <p>注意事项：
如果参数对象是不可变的（如<code>String</code>和其它基本数据类型），则不需要使用<code>out</code>或<code>inout</code>关键字，因为服务端无法修改其内容 。
如果参数对象是可变的（如<code>List</code>或<code>Map</code>），则需要根据实际需求选择合适的关键字，以避免不必要的数据拷贝和传输 。
<code>inout</code>对<code>AIDL</code>接口的性能有着不小的影响，一定不要滥用。</p> <h2 id="_3-传递复数个对象"><a href="#_3-传递复数个对象" class="header-anchor">#</a> 3. 传递复数个对象</h2> <p><code>AIDL</code> 支持传递一些基本类型和 <code>Parcelable</code> 类型的数据。如果需要传递一些复杂的对象或者多个对象以及数量不定的对象时，可以使用 <code>Bundle</code> 类来封装这些数据，然后通过 <code>AIDL</code> 接口传递 <code>Bundle</code> 对象。<code>Bundle</code> 类是一个键值对的容器，它可以存储不同类型的数据，并且实现了 <code>Parcelable</code> 接口，所以可以在进程间传输。
如果 <code>AIDL</code> 接口包含接收<code>Bundle</code>作为参数（预计包含 <code>Parcelable</code> 类型）的方法，则在尝试从3读取之前，请务必通过调用 <code>Bundle.setClassLoader(ClassLoader)</code> 设置<code>Bundle</code>的类加载器。否则，即使在应用中正确定义 <code>Parcelable</code> 类型，也会遇到 <code>ClassNotFoundException</code></p> <h2 id="_4-传递大文件"><a href="#_4-传递大文件" class="header-anchor">#</a> 4. 传递大文件</h2> <p><code>AIDL</code>是一种基于<code>Binder</code>实现的跨进程调用方案，<code>Binder</code> 对传输数据大小有限制，传输超过 1M 的文件就会报 <code>android.os.TransactionTooLargeException</code> 异常。不过依然有大文件传输的解决方案，其中一种解决办法是，使用<code>AIDL</code>传递文件描述符<code>ParcelFileDescriptor</code>，来实现超大型文件的跨进程传输。
该部分内容较多，可以查看文章：《Android 使用AIDL传输超大型文件》
<a href="https://juejin.cn/post/7218615271384088633" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/7218615271384088633<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="_5-耗时操作"><a href="#_5-耗时操作" class="header-anchor">#</a> 5. 耗时操作</h2> <p><code>Android AIDL</code> 通信本身是一个耗时操作，因为它涉及到进程间的数据传输和序列化/反序列化的过程。如果在「客户端」的主线程中调用 <code>AIDL</code> 接口，而且「服务端」的方法执行比较耗时，就会导致「客户端」主线程被阻塞，从而引发<code>ANR</code>。
为了避免 <code>AIDL</code> 引起的 <code>ANR</code>，可以采取以下这些措施：</p> <ul><li>不要在主线程中调用 <code>AIDL</code> 接口，而是使用子线程或者异步任务来进行 <code>IPC</code>。</li> <li>不要在 <code>onServiceConnected ()</code> 或者 <code>onServiceDisconnected ()</code> 中直接操作服务端方法，因为这些方法是在主线程中执行的。</li> <li>使用<code>oneway</code>键字来修饰 <code>AIDL</code> 接口，使得 <code>IPC</code> 调用变成非阻塞的。</li></ul> <p><strong><code>Oneway</code>简介</strong></p> <p><code>oneway</code> 是<code>AIDL</code>定义接口时可选的一个关键字，它可以修饰 <code>AIDL</code> 接口中的方法，修改远程调用的行为。
<code>oneway</code>主要有以下两个特性：
将远程调用改为「异步调用」，使得远程调用变成非阻塞式的，客户端不需要等待服务端的处理，只是发送数据并立即返回。
<code>oneway</code>修饰方法，在同一个<code>IBinder</code>对象调用中，会按照调用顺序依次执行。</p> <p><strong><code>Oneway</code>的使用场景</strong></p> <p>使用 <code>oneway</code> 的场景一般是当<strong>不需要等待服务端的返回值或者回调</strong>时，可以提高 <code>IPC</code> 的效率。例如，您可能需要向服务端发送一些控制命令或者通知，而不关心服务端是否处理成功。
<code>oneway</code>可以用来修饰在<code>interface</code>之前，这样会使<code>interface</code>内所有的方法都隐式地带上<code>oneway</code>，也可以修饰在<code>interface</code>里的各个方法之前。</p> <p><code>Oneway</code>的注意事项</p> <p>给<code>AIDL</code>接口添加<code>oneway</code>关键词有以下的事项需要注意：</p> <ul><li><code>oneway</code> 修饰本地调用没有效果，仍然是同步的，「客户端」需要等待「服务端」的处理。</li> <li><code>oneway</code> 不能用于修饰有返回值的方法，或者抛出异常，因为「客户端」无法接收到这些信息。</li> <li>同一个<code>IBinder</code>对象进行<code>oneway</code>调用，这些调用会按照原始调用的顺序依次执行。不同的<code>IBinder</code>对象可能导致调用顺序和执行顺序不一致。
<code>oneway</code> 要谨慎用于修饰调用极其频繁的<code>IPC</code>接口
当「服务端」的处理较慢，但是「客户端」的<code>oneway</code>调用非常频繁时，来不及处理的调用会占满<code>binder</code>驱动的缓存，导致<code>transaction failed</code>。</li></ul> <h2 id="_6-服务端向客户端发起回调"><a href="#_6-服务端向客户端发起回调" class="header-anchor">#</a> 6. 服务端向客户端发起回调</h2> <p>如果尝试针对同一个<code>listener</code>通过<code>registerListener</code>和<code>unRegisterLisenter</code>接口来注册和取消注册，会发现他们的</p> <blockquote><p>我们注册给服务端的方法的签名和我们解注册时注册再传给服务端的方法签名是不一样的，因为<code>AIDL</code>涉及到对象的序列化，导致两次传递给服务端的对象并不是同一个，如果我们把<code>listener</code>保存到<code>List</code>中，实际我们是无法找到我们<code>List</code>中保存的是哪一个的</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>D/AIDLCalculatorService: onCreate:
D/AIDLCalculatorService: registerListener: com.ihblu.sdk.listener.ICalculatorListener$Stub$Proxy@b0013fd
D/AIDLCalculatorService: unregisterListener: com.ihblu.sdk.listener.ICalculatorListener$Stub$Proxy@7cdc8f2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果在服务端打印的是<code>listener.asBinder()</code>则会显示是同一个对象</p> <p>服务端需要主动向客户端发起请求的情况，这时我们就需要在服务端保存一个客户端的 <code>Binder</code> 实例，在需要时服务端就可以通过这个 <code>Binder</code> 来向客户端发出请求。</p> <p>由于一个服务端可能会同时连接多个客户端，所以对于客户端注册过来的 <code>Binder</code>实例，我们需要使用一个<code>List</code>集合来保存它，如果使用<code>ArrayList</code>或<code>CopyOnWriteArrayList</code>保存「客户端」的<code>Binder</code>实例，需要在客户端与服务端的连接断开时，将保存的<code>Binder</code>清除。如果调用已经解除连接的<code>Binder</code>，会抛出<code>DeadObjectException</code>。</p> <h2 id="_7-remotecallbacklist"><a href="#_7-remotecallbacklist" class="header-anchor">#</a> 7. RemoteCallbackList</h2> <p><code>RemoteCallbackList</code>是一个类，它用于管理一组已注册的<code>IInterface</code>回调，并在它们的进程消失时自动从列表中清理它们。<code>RemoteCallbackList</code>通常用于执行从<code>Service</code>到其客户端的回调，实现跨进程通信。
<code>RemoteCallbackList</code>具有以下优势：</p> <ol><li>它通过调用<code>IInterface.asBinder()</code>方法，根据底层的唯一<code>Binder</code>来识别每个注册的接口。</li> <li>它给每个注册的接口附加了一个<code>IBinder.DeathRecipient</code>，这样如果接口所在的进程死亡了，它就可以从列表中清除掉。</li> <li>它对底层接口列表进行了加锁处理，以应对多线程的并发调用，同时提供了一种线程安全的方式来遍历列表的快照，而不需要持有锁。
要使用这个类，需要创建一个实例，并调用它的<code>register(E)</code>和<code>unregister(E)</code>方法作为客户端注册和取消注册服务。要回调到注册的客户端，请使用<code>beginBroadcast()</code>、<code>getBroadcastItem(int)</code>和<code>finishBroadcast()</code>方法。</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ICalculator<span class="token punctuation">.</span>Stub</span> mICalculator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ICalculator<span class="token punctuation">.</span>Stub</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RemoteCallbackList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ICalculatorListener</span><span class="token punctuation">&gt;</span></span> mListeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RemoteCallbackList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerListener</span><span class="token punctuation">(</span><span class="token class-name">ICalculatorListener</span> listener<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;registerListener: &quot;</span> <span class="token operator">+</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mListeners<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">notifyClients</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unregisterListener</span><span class="token punctuation">(</span><span class="token class-name">ICalculatorListener</span> listener<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;unregisterListener: &quot;</span> <span class="token operator">+</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mListeners<span class="token punctuation">.</span><span class="token function">unregister</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;unregisterListener: &quot;</span> <span class="token operator">+</span> mListeners<span class="token punctuation">.</span><span class="token function">getRegisteredCallbackCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">notifyClients</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> n <span class="token operator">=</span> mListeners<span class="token punctuation">.</span><span class="token function">beginBroadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mListeners<span class="token punctuation">.</span><span class="token function">getBroadcastItem</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onCallback</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mListeners<span class="token punctuation">.</span><span class="token function">finishBroadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><ul><li><p>如果我们想知道客户端和服务器端什么时候断开的，可以在客户端自定义一个<code>RemoteCallbackList</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRemoteCallbackList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">IInterface</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">RemoteCallbackList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">// 如果客户端和服务端断开连接会回调该方法</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCallbackDied</span><span class="token punctuation">(</span><span class="token class-name">T</span> callback<span class="token punctuation">,</span> <span class="token class-name">Object</span> cookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCallbackDied</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">&quot;MyRemoteCallbackList&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;onCallbackDied: callback: &quot;</span> <span class="token operator">+</span> callback <span class="token operator">+</span> <span class="token string">&quot; cookie: &quot;</span> <span class="token operator">+</span> cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>服务端注册监听的时候添加<code>cookie</code>参数</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerListener</span><span class="token punctuation">(</span><span class="token class-name">ICalculatorListener</span> listener<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;registerListener: &quot;</span> <span class="token operator">+</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mListeners<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">notifyClients</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>当我们手动把客户端杀掉时，会收到回调：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>2023-05-28 15:29:12.977 6590-6605/com.ihblu.service I/AIDLCalculatorService: registerListener: com.ihblu.sdk.listener.ICalculatorListener$Stub$Proxy@b0013fd
2023-05-28 15:29:26.334 6590-6605/com.ihblu.service E/MyRemoteCallbackList: onCallbackDied: callback: com.ihblu.sdk.listener.ICalculatorListener$Stub$Proxy@b0013fd cookie: hello
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ul> <h2 id="_8-服务端存在多个binder"><a href="#_8-服务端存在多个binder" class="header-anchor">#</a> 8. 服务端存在多个Binder</h2> <p>上面示例中，我们只定义了一个 <code>Binder</code> 实例即 <code>ICalculator</code> ，当客户端需要与服务端进行多种不同的业务交互时，就需要在服务端定义多个不同的<code>Binder</code>实例，此时我们可以引入<code>BinderPool</code>机制来优化这种场景。
<code>BinderPool</code>是一个用于管理和分发<code>Binder</code>的机制，它可以让不同的模块之间通过一个统一的<code>Service</code>进行<code>Binder</code>通信，客户端通过一个<code>Binder</code>连接到服务端，然后根据不同的业务需求，获取到对应的<code>Binder</code>实例，从而实现跨进程通信。这样可以减少客户端和服务端之间的连接数，提高性能和稳定性。</p> <h2 id="_9-aidl的权限控制"><a href="#_9-aidl的权限控制" class="header-anchor">#</a> 9. AIDL的权限控制</h2> <ul><li><p><strong>控制客户端的绑定权限</strong>
在对外暴露<code>AIDL</code>接口时，我们并不希望所有的客户端都可以连接到<code>Service</code>中，那么我们可以自定义权限，限制具有指定权限的应用才可以绑定到服务端。</p> <p>在<code>Service</code>的清单文件中，添加一个<code>android:permission</code>属性，指定一个自定义的权限名称。这样，只有拥有这个权限的客户端才能绑定到这个<code>Service</code></p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>permission</span>    
    <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.example.permission.BIND_MY_SERVICE<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>protectionLevel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>signature<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>.MyService<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">android:</span>permission</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.example.permission.BIND_MY_SERVICE<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span>queries<span class="token punctuation">&gt;</span></span>
    <span class="token operator">&lt;</span><span class="token keyword">package</span> <span class="token namespace">android</span><span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;com.ihblu.service&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>queries<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;com.ihblu.permission.BIND_MY_SERVICE&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>protectionLevel</code>有以下几种：</p> <ol><li><code>normal</code>：默认值，表示低风险的权限，系统会自动授予请求的应用，无需用户同意。</li> <li><code>dangerous</code>：表示高风险的权限，涉及用户私人数据或设备控制权，系统会向用户显示并确认是否授予请求的应用。</li> <li><code>signature</code>：表示只有当请求的应用和声明权限的应用使用相同的证书签名时，系统才会授予的权限。</li> <li><code>signatureOrSystem</code>：表示只有当请求的应用和声明权限的应用使用相同的证书签名，或者请求的应用位于系统映像的专用文件夹中时，系统才会授予的权限。</li></ol> <div class="language- extra-class"><pre><code>这个参数在 API 级别 23中已弃用，建议使用 signature。
</code></pre></div></li> <li><p><strong>控制客户端对接口的使用权限</strong>
除了控制连接<code>Service</code>的权限，多数时候我们还需要控制<code>aidl</code>接口的请求权限，避免客户端可以随意访问一些危险的<code>aidl</code>接口</p> <p><code>checkCallingPermission()</code>和 <code>enforceCallingPermission()</code>都可以用于权限检查，区别在于</p> <ul><li><code>int checkCallingPermission(String permission)</code>：检查调用者是否有指定的权限。如果没有调用者或者调用者不是 <code>IPC</code>，则返回-1，如果<code>IPC</code>调用者有指定的权限则返回 0 。</li> <li><code>void enforceCallingPermission</code>：检查调用者是否有指定的权限，如果没有或者没有调用者或者调用者不是 <code>IPC</code>，则抛出 <code>SecurityException</code> 异常。</li></ul> <p>除了上面的方法，还有以下一些较为常用的用于检查<code>AIDL</code>接口的方法。</p> <ul><li><code>int checkPermission(String permission, int pid, int uid)</code>：检查指定的进程和用户ID是否有指定的权限。</li> <li><code>int checkCallingOrSelfPermission(String permission)</code>：检查调用者或者自身是否有指定的权限，如果没有调用者，则相当于 <code>checkSelfPermission</code>。这个方法要谨慎使用，因为它可能会授予缺少权限的恶意应用访问受保护的资源。</li> <li><code>int checkSelfPermission(String permission)</code>：检查自身是否有指定的权限，这是运行时动态检查的方式，通常用于请求危险权限。</li> <li><code>void enforcePermission(String permission, int pid, int uid, @Nullable String message)</code>：检查指定的进程和用户 ID 是否有指定的权限，如果没有，则抛出 <code>SecurityException</code> 异常。</li> <li><code>void enforceCallingOrSelfPermission(String permission, @Nullable String message)</code>：检查调用者或者自身是否有指定的权限，如果没有，则抛出 <code>SecurityException</code> 异常。如果没有调用者，则相当于 <code>enforcePermission</code>。这个方法要谨慎使用，因为它可能会授予缺少权限的恶意应用访问受保护的资源。</li></ul> <p><code>Binder.getCallingPid()</code>和<code>Binder.getCallingUid()</code>都是用来获取调用者（即发送<code>Binder</code>请求的进程）的信息的。区别在于：</p> <ul><li><code>Binder.getCallingPid()</code>方法返回调用者的进程<code>ID</code>，它是一个<code>int</code>类型的值，可以用来区分不同的进程。这个方法是从<code>API 1</code>就存在的，可以在任何版本的<code>Android</code>上使用。</li> <li><code>Binder.getCallingUid()</code>方法返回调用者的用户<code>ID</code>，它是一个<code>int</code>类型的值，可以用来区分不同的用户或应用。这个方法是从<code>API 1</code>就存在的，可以在任何版本的<code>Android</code>上使用。
这两个方法都只能在<code>Binder</code>的方法中调用，否则会返回当前进程或者用户的<code>ID</code>。它们可以用来检查调用者是否拥有某些权限，或者进行一些安全验证。</li></ul> <blockquote><p>在<code>Service</code>中使用这两个方法时需要注意，接口不能使用<code>oneway</code>修饰，不然是获取不到<code>Pid</code>的</p></blockquote> <p>新定义一个接口方法为<code>optionPermission()</code>，在服务端的<code>AndroidManifest.xml</code>中声明需要的权限：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">&lt;</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;com.ihblu.permission.HELLO&quot;</span>
        android<span class="token operator">:</span>protectionLevel<span class="token operator">=</span><span class="token string">&quot;signature&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>application
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在<code>service</code>中的实现中判断是否拥有权限：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PERMISSION</span> <span class="token operator">=</span> <span class="token string">&quot;com.ihblu.permission.HELLO&quot;</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">optionPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> checked <span class="token operator">=</span> mContext<span class="token punctuation">.</span><span class="token function">checkCallingPermission</span><span class="token punctuation">(</span><span class="token constant">PERMISSION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token class-name">PackageManager</span><span class="token punctuation">.</span><span class="token constant">PERMISSION_GRANTED</span> <span class="token operator">==</span> checked<span class="token punctuation">;</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;optionPermission: &quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>客户端需要在<code>AndroidManifest.xml</code>中声明这个权限，否则<code>result</code>为<code>false</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;com.ihblu.permission.HELLO&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul> <h2 id="_10-封装aidl-sdk"><a href="#_10-封装aidl-sdk" class="header-anchor">#</a> 10. 封装AIDL SDK</h2> <p>将<code>AIDL</code>封装成<code>SDK</code>时，一般需要遵守以下原则：</p> <ul><li>简化客户端的调用成本</li> <li>隐藏<code>Service</code>重连机制，使调用方无需关心<code>Service</code>重连的具体实现</li> <li>减少客户端与服务端的不必要的通信次数，提高性能</li> <li>根据需要进行权限验证</li></ul></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间: </span> <span class="time">2023-9-17 10:29:00 ├F10: AM┤</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/blog/handbook/android/自定义按键添加.html" class="prev">
          自定义按键添加
        </a></span> <span class="next"><a href="/blog/handbook/android/Android开机动画详解.html">
          Android开机动画详解
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/blog/handbook/aidl/aidl.html#_1-数据类型" class="sidebar-link reco-side-_1-数据类型" data-v-b57cc07c>1. 数据类型</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/handbook/aidl/aidl.html#_2-数据流方向" class="sidebar-link reco-side-_2-数据流方向" data-v-b57cc07c>2. 数据流方向</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/handbook/aidl/aidl.html#_3-传递复数个对象" class="sidebar-link reco-side-_3-传递复数个对象" data-v-b57cc07c>3. 传递复数个对象</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/handbook/aidl/aidl.html#_4-传递大文件" class="sidebar-link reco-side-_4-传递大文件" data-v-b57cc07c>4. 传递大文件</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/handbook/aidl/aidl.html#_5-耗时操作" class="sidebar-link reco-side-_5-耗时操作" data-v-b57cc07c>5. 耗时操作</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/handbook/aidl/aidl.html#_6-服务端向客户端发起回调" class="sidebar-link reco-side-_6-服务端向客户端发起回调" data-v-b57cc07c>6. 服务端向客户端发起回调</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/handbook/aidl/aidl.html#_7-remotecallbacklist" class="sidebar-link reco-side-_7-remotecallbacklist" data-v-b57cc07c>7. RemoteCallbackList</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/handbook/aidl/aidl.html#_8-服务端存在多个binder" class="sidebar-link reco-side-_8-服务端存在多个binder" data-v-b57cc07c>8. 服务端存在多个Binder</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/handbook/aidl/aidl.html#_9-aidl的权限控制" class="sidebar-link reco-side-_9-aidl的权限控制" data-v-b57cc07c>9. AIDL的权限控制</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/handbook/aidl/aidl.html#_10-封装aidl-sdk" class="sidebar-link reco-side-_10-封装aidl-sdk" data-v-b57cc07c>10. 封装AIDL SDK</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/blog/assets/js/app.a89a3ba2.js" defer></script><script src="/blog/assets/js/3.b8b532c4.js" defer></script><script src="/blog/assets/js/1.4116e08c.js" defer></script><script src="/blog/assets/js/12.eb8f308d.js" defer></script>
  </body>
</html>
